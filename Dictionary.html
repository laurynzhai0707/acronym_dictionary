<!-- PAGE-CENTERED WRAPPER -->
<div style="width: 100%; display: flex; justify-content: center; margin-top: 50px;">
  <div style="max-width: 1000px; width: 100%; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 25px; border-radius: 10px; background-color: #fff;">

    <!-- User Guide -->
    <p style="font-size: 14px; margin-bottom: 20px; color: #444;text-align: left;">
      üîç <strong>How to Use:</strong><br>
      ‚Ä¢ Use the search fields below to find existing acronyms by typing either the abbreviation or the full name.<br>
      ‚Ä¢ When entering a new acronym, the field will auto-search for duplicates in the list below.<br>
      ‚Ä¢ Please ensure your submission is new and complete before adding.<br>
    </p>

    <!-- SEARCH BAR AND UPLOAD FORM WRAPPER -->
    <div style="width: 100%; display: flex; justify-content: center;">
      <div style="width: 1000px;">

        <!-- Search UI (Full width alignment) -->
        <div id="searchBarWrapper" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; justify-content: flex-start;">
          <input id="acronymSearchBox" placeholder="Search by Acronym (e.g., HACI)" onkeyup="searchTable()" style="width: 300px; padding: 8px;">
          <input id="nameSearchBox" placeholder="Search by Name (e.g., Honda Aircraft Company)" onkeyup="searchTable()" style="width: 300px; padding: 8px;">
          <button type="button" onclick="toggleUploadForm()" style="padding: 8px;">‚ûï Add Acronym</button>
        </div>

        <!-- Upload Form -->
        <div id="uploadForm" style="display:none; margin-top:20px;">
          <div style="background-color:#f9f9f9; padding:15px; border-radius:8px; border:1px solid #ddd; text-align:left;">
            <p style="margin:0 0 10px 0; font-weight:bold;">Fill out information about the new acronym below</p>
            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
              <textarea id="newAcronym" placeholder="Acronym (required)" style="padding:6px; width:120px; min-height:80px; resize:none;"></textarea>
              <textarea id="newName" placeholder="Name (required)" style="padding:6px; width:120px; min-height:80px; resize:none;"></textarea>
              <textarea id="newExplanation" placeholder="Explanation (optional)" style="padding:6px; flex-grow:1; min-width:300px; min-height:80px; resize:none;"></textarea>
            </div>
            <button type="button" onclick="submitAcronym()" style="padding:6px 12px;">Submit</button>
          </div>
        </div>

      </div>
    </div>

    <!-- Acronym Table -->
    <table id="acronymTable" style="width:100%;border-collapse:collapse;margin-top:20px;">
      <thead id="tableHead" style="display:none;">
        <tr style="background:#f4f4f4;">
          <th style="border:1px solid #ccc;padding:10px;width:120px;">Acronym</th>
          <th style="border:1px solid #ccc;padding:10px;width:120px;">Name</th>
          <th style="border:1px solid #ccc;padding:10px;">Explanation</th>
          <th style="border:1px solid #ccc;padding:10px;width:120px;">Feedback</th>
        </tr>
      </thead>
      <tbody id="tableBody" style="display:none;"></tbody>
    </table>

    <!-- No Results Message -->
    <div id="noResultsMessage" style="display:none; margin-top:10px; font-style:italic; color:#888;">
      No results found.
    </div>

  </div>
</div>

<script type="text/javascript">
(function () {
  const siteUrl  = _spPageContextInfo.webAbsoluteUrl;
  const listName = "AcronymFeedback";
  const COL_ACRONYM = "Title", COL_NAME = "Name", COL_EXPLANATION = "Explanation", COL_UP = "ThumbsUp", COL_DOWN = "ThumbsDown";
  let listItemType = "";

  fetch(`${siteUrl}/_api/web/lists/getbytitle('${listName}')`, {
    headers:{Accept:"application/json;odata=verbose"}, credentials:"include"
  }).then(r => r.json()).then(d => {
    listItemType = d.d.ListItemEntityTypeFullName;
    loadItems();
  });

  window.toggleUploadForm = () => {
    const f = document.getElementById("uploadForm");
    const a = document.getElementById("acronymSearchBox").value.trim();
    const n = document.getElementById("nameSearchBox").value.trim();
    if (f.style.display === "none") {
      if (a) document.getElementById("newAcronym").value = a.toUpperCase();
      if (n) document.getElementById("newName").value = n;
    }
    f.style.display = f.style.display === "none" ? "block" : "none";
  };

  window.submitAcronym = () => {
    const ac = document.getElementById("newAcronym").value.trim().toUpperCase();
    const nm = document.getElementById("newName").value.trim();
    const ex = document.getElementById("newExplanation").value.trim();
    if (!ac || !nm) { alert("Acronym and Name are required."); return; }

    const rows = [...document.querySelectorAll("#acronymTable tbody tr")];
    const duplicate = rows.some(tr => tr.cells[0].innerText.toUpperCase() === ac);
    if (duplicate && !confirm("‚ö†Ô∏è This acronym already exists. Do you want to submit it again?")) return;

    fetch(`${siteUrl}/_api/web/lists/getbytitle('${listName}')/items`, {
      method: "POST",
      headers: {
        Accept:"application/json;odata=verbose",
        "Content-Type": "application/json;odata=verbose",
        "X-RequestDigest": document.getElementById("__REQUESTDIGEST").value
      },
      credentials: "include",
      body: JSON.stringify({
        __metadata: { type: listItemType },
        [COL_ACRONYM]: ac,
        [COL_NAME]: nm,
        [COL_EXPLANATION]: ex
      })
    }).then(r => r.ok ? alert("‚úÖ Acronym added!") : r.text().then(t => Promise.reject(t)))
      .then(() => { toggleUploadForm(); loadItems(); })
      .catch(e => { console.warn(e); alert("‚ùå Failed to add acronym."); });
  };

  function loadItems(){
    fetch(`${siteUrl}/_api/web/lists/getbytitle('${listName}')/items?$top=5000`, {
      headers:{Accept:"application/json;odata=verbose"}, credentials:"include"
    }).then(r => r.json()).then(d => {
      const tb = document.getElementById("tableBody");
      tb.innerHTML = "";
      d.d.results.forEach(it => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td style="border:1px solid #ccc;padding:10px;width:120px;">${it[COL_ACRONYM]||""}</td>
          <td style="border:1px solid #ccc;padding:10px;width:120px;">${it[COL_NAME]||""}</td>
          <td style="border:1px solid #ccc;padding:10px;">${it[COL_EXPLANATION]||""}</td>
          <td style="border:1px solid #ccc;padding:10px;width:120px;text-align:center;">
            <span style="cursor:pointer; margin-right:15px;" onclick="vote(${it.Id},'${COL_UP}',this)">üëç <span class="count">${it[COL_UP]||0}</span></span>
            <span style="cursor:pointer; opacity:${getVote(it.Id)===COL_DOWN?'0.4':'1'};" onclick="vote(${it.Id},'${COL_DOWN}',this)">üëé <span class="count" style="display:none;">${it[COL_DOWN]||0}</span></span>
          </td>`;
        tb.appendChild(row);
      });
    });
  }

  window.searchTable = () => {
    const a = document.getElementById("acronymSearchBox").value.trim().toUpperCase();
    const n = document.getElementById("nameSearchBox").value.trim().toUpperCase();
    const rows = [...document.querySelectorAll("#acronymTable tbody tr")];
    let anyMatch = false;

    rows.forEach(tr => {
      const match = tr.cells[0].innerText.toUpperCase().includes(a) &&
                    tr.cells[1].innerText.toUpperCase().includes(n);
      tr.style.display = match ? "" : "none";
      if (match) anyMatch = true;
    });

    const tableBody = document.getElementById("tableBody");
    const tableHead = document.getElementById("tableHead");
    const noResults = document.getElementById("noResultsMessage");
    const uploadForm = document.getElementById("uploadForm");

    const hasInput = a.length > 0 || n.length > 0;
    tableBody.style.display = hasInput && anyMatch ? "table-row-group" : "none";
    tableHead.style.display = hasInput && anyMatch ? "table-header-group" : "none";
    noResults.style.display = hasInput && !anyMatch ? "block" : "none";

    // FIXED: Auto-show/hide upload form
    if (hasInput && !anyMatch) {
      uploadForm.style.display = "block";
      if (a) document.getElementById("newAcronym").value = a;
      if (n) document.getElementById("newName").value = n;
    } else {
      uploadForm.style.display = "none";
      document.getElementById("newAcronym").value = "";
      document.getElementById("newName").value = "";
      document.getElementById("newExplanation").value = "";
    }
  };

  function voteKey(id){ return `vote_${id}`; }
  function getVote(id){ return localStorage.getItem(voteKey(id)); }
  function setVote(id,f){ localStorage.setItem(voteKey(id), f); }
  function clearVote(id){ localStorage.removeItem(voteKey(id)); }

  window.vote = (id, field, el) => {
    const opp = field === COL_UP ? COL_DOWN : COL_UP;
    const prev = getVote(id);
    const span = el.querySelector(".count");
    let cnt = parseInt(span.innerText) || 0;

    if (prev === field) {
      cnt = Math.max(0, cnt - 1);
      clearVote(id);
      el.style.opacity = "1";
    } else {
      if (prev === opp) {
        alert("‚ö†Ô∏è Remove opposite vote first.");
        return;
      }

      cnt++;
      setVote(id, field);
      if (field === COL_DOWN) {
        el.style.opacity = "0.4";
      }
    }

    fetch(`${siteUrl}/_api/web/lists/getbytitle('${listName}')/items(${id})`, {
      method: "POST",
      headers: {
        Accept:"application/json;odata=verbose",
        "Content-Type": "application/json;odata=verbose",
        "X-RequestDigest": document.getElementById("__REQUESTDIGEST").value,
        "IF-MATCH": "*",
        "X-HTTP-Method": "MERGE"
      },
      credentials:"include",
      body: JSON.stringify({ __metadata: { type: listItemType }, [field]: cnt })
    }).then(() => { span.innerText = cnt; });
  };
})();

document.getElementById("acronymSearchBox").addEventListener("input", function () {
  if (!this.value.trim()) document.getElementById("newAcronym").value = "";
});

document.getElementById("nameSearchBox").addEventListener("input", function () {
  if (!this.value.trim()) document.getElementById("newName").value = "";
});
</script>